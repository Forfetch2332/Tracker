{% extends "layout.html" %}
{% block content %}

<h3 class="mb-3">{{ practice.title }}</h3>

<!-- Основная статистика -->
<div class="row mb-4">

    <div class="col-md-3">
        <div class="card shadow-sm">
            <div class="card-body text-center">
                <h6>Всего выполнено</h6>
                <div class="fs-4">{{ total_done }}</div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card shadow-sm">
            <div class="card-body text-center">
                <h6>Текущий стрик</h6>
                <div class="fs-4">{{ current_streak }}</div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card shadow-sm">
            <div class="card-body text-center">
                <h6>Лучший стрик</h6>
                <div class="fs-4">{{ best_streak }}</div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card shadow-sm">
            <div class="card-body text-center">
                <h6>Процент дней</h6>
                <div class="fs-4">{{ percent_days }}%</div>
            </div>
        </div>
    </div>

</div>

<!-- График -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h5 class="mb-3">График выполнения</h5>
        <canvas id="chart" height="100"></canvas>
    </div>
</div>

<!-- Тепловая карта -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h5 class="mb-3">Тепловая карта</h5>

        <div class="d-flex flex-wrap" style="gap: 4px;">
            {% for cell in heatmap %}
                <div style="
                    width: 18px;
                    height: 18px;
                    border-radius: 3px;
                    background-color:
                        {% if cell.count == 0 %}#e0e0e0
                        {% elif cell.count == 1 %}#b2df8a
                        {% elif cell.count == 2 %}#66bb6a
                        {% else %}#2e7d32{% endif %};
                "
                     title="{{ cell.date }}: {{ cell.count }}">
                </div>
            {% endfor %}
        </div>

    </div>
</div>

<!-- История -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h5 class="mb-3">История</h5>

        {% if entries_by_date %}
            <div class="accordion" id="historyAccordion">

                {% for d, entries in entries_by_date.items() %}
                <div class="accordion-item">

                    <h2 class="accordion-header" id="heading{{ loop.index }}">
                        <button class="accordion-button collapsed" type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#collapse{{ loop.index }}">
                            {{ d }}
                        </button>
                    </h2>

                    <div id="collapse{{ loop.index }}"
                         class="accordion-collapse collapse"
                         data-bs-parent="#historyAccordion">

                        <div class="accordion-body">

                            {% for e in entries %}
                                <div class="mb-3">
                                    {% for key, value in e.fields.items() %}
                                        <div><strong>{{ key }}:</strong> {{ value }}</div>
                                    {% endfor %}
                                </div>
                            {% endfor %}

                        </div>

                    </div>

                </div>
                {% endfor %}

            </div>
        {% else %}
            <p class="text-muted">Нет данных.</p>
        {% endif %}

    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const ctx = document.getElementById('chart').getContext('2d');

    const labels = {{ chart_labels | tojson }};
    const values = {{ chart_values | tojson }};

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Выполнений',
                data: values,
                borderColor: '#2e7d32',
                backgroundColor: 'rgba(46, 125, 50, 0.2)',
                borderWidth: 2,
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
</script>

{% endblock %}
